<!doctype html>
<html>

<head>

  <title>polySlides</title>

  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <script src="components/platform/platform.js"></script>
  <script src="jquery.min.js"></script>

  <link rel="import" href="components/core-item/core-item.html">
  <link rel="import" href="components/core-menu/core-menu.html">
  <link rel="import" href="components/core-header-panel/core-header-panel.html">
  <link rel="import" href="components/core-icon-button/core-icon-button.html">
  <link rel="import" href="components/core-toolbar/core-toolbar.html">

  <link rel="import" href="components/polyslides/polyslides-cover.html">
  <link rel="import" href="components/polyslides/polyslides-default.html">

  <style>
    .dark {
      background-color: #333;
      padding-right: 30px;
    }

    .dark core-item {
      color: #fafafa;
      fill: #fafafa;
    }
    html,body, .globalContainer {
      height: 100%;
      width: 100%;
      margin: 0;
      background-color: #E5E5E5;
      font-family: 'Calibri', sans-serif;
    }
    core-header-panel {
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch; 
    }
    core-toolbar {
      background: #03a9f4;
      color: white;
    }
    .container {
      width: 80%;
      height: 80%;
      margin: 50px auto;
    }
    @media (min-width: 481px) {
      .container {
        width: 400px;
        height: 100%;
      }
    }
    .timebox {
      width: 80%;
      text-align: right;
    }
  </style>

</head>

<body unresolved>

  <core-header-panel>
    <div layout horizontal>
      <div class="dark">
        <core-menu id="menu" selected="0">
        </core-menu>
      </div>
      <div class="globalContainer">
        <core-toolbar>
          <div style="width:100%" layout horizontal center>
            <div layout horizontal center>
              <core-icon-button icon="chevron-left" onclick="window.prev()"></core-icon-button>
              <p>polySlides</p>
              <core-icon-button icon="chevron-right" onclick="window.next()"></core-icon-button>
            </div>
            <div class="timebox" id="show_time">
              00:00:00
            </div>
          </div>
        </core-toolbar>
        <div class="container" id="container" layout vertical center onclick="window.next()"></div>
      </div>
    </div>
  </core-header-panel>


  <script>
    window.ele=[];
    window.counter=0;
    window.max=0;
    window.is_show_valid=true;
    window.slideSpecialEffects=function(ele, delta, time, callback){
      if(typeof ele=='undefined'){
        callback();
        return;
      }
      var newValue=ele.style.opacity-(-delta);
      if((newValue>1)||(newValue<0)){
        if(newValue>1){
          newValue=1;
        }else{
          newValue=0;
        }
        ele.style.opacity=newValue;
        callback();
        return;
      }
      ele.style.opacity=newValue;
      window.setTimeout(
        function(){
          slideSpecialEffects(ele, delta, time, callback);
        },
        time
      );
    }
    window.show=function(id){
      if(!is_show_valid) return;
      is_show_valid=false;
      counter=id;
      var body=document.querySelector("#container");
      var slide=body.childNodes[0];

      slideSpecialEffects(slide, -0.1, 20, function(){ 
        body.innerHTML="";
        body.appendChild(ele[id]); 
        slideSpecialEffects(ele[id], 0.1, 20, function(){ 
          document.querySelector("#menu").selected=id; 
          is_show_valid=true;
        }); 
      });

    }
    window.next=function(){
      if(counter===max) return;
      show(counter+1);
    }
    window.prev=function(){
      if(counter===0) return;
      show(counter-1);
    }
    window.getConfig=function(default_config, custom_config){
      var res={};
      for(i in default_config) res[i]=default_config[i];
      for(i in custom_config) res[i]=custom_config[i];
      return res;
    }
    window.loadData=function(data){

      data=eval(data);
      max=-1;
      var menu=document.querySelector("#menu");

      var global_config=getConfig({ background: "#FFFFFF", template: "default" },data[0]);
      var local_config;

      for(var i=1;i<data.length;i++){ // foreach slide

        var title="";
        local_config=getConfig(global_config, data[i][0]);
        var element=document.createElement("polyslides-"+local_config.template);
        element.style.opacity=0;
        element.style.background=local_config.background;
        ele.push(element); 
        var slideData=data[i][1];

        for(j in slideData){ // foreach node in slide
          var nodeType="p";  // the default node type is "p"
          var inner;
          if(slideData[j].length!==1){
            nodeType=slideData[j][0];
            inner=slideData[j][1];
          }else{
            inner=slideData[j][0];
          }
          if(nodeType==="h1"){
            title=inner;
          }
          var node=document.createElement(nodeType);
          element.appendChild(node);
          if((nodeType!="img") && (nodeType !="iframe") && (nodeType !="a")){
            node.innerHTML=inner;
          }else{
            node.src=inner;
          }
        }

        // update menu
        var slideItem=document.createElement("core-item");
        menu.appendChild(slideItem);
        max+=1;
        if(title.length>13) {
          title=title.substr(0,12)+"..";
        }
        slideItem.setAttribute("label",title);
        slideItem.setAttribute("onclick","window.show("+max+")");

      }

      // render the first slide
      counter=0;
      show(counter);

    }
    
    $(document).ready(function(){
      $.get("slides/slides.json",function(data){
        loadData(data);
      });
      window.setInterval(function(){
        var date=new Date();
        var trim=function(t){
          if(t<10) t="0"+t;
          return t;
        }
        document.getElementById("show_time").innerHTML=trim(date.getHours())+":"+trim(date.getMinutes())+":"+trim(date.getSeconds());
      },1000);
    });

  </script>
	  
</body>

</html>